name: Build Tizen WGT (Enact)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  wgt:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        node: [22]
        tizen: ["5.6"]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: Setup Java (Tizen CLI runs on Java)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"

      - name: Install OS dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y curl unzip zip cpio rpm2cpio
          sudo apt-get install -y libwebkitgtk-1.0-0 || sudo apt-get install -y libwebkit2gtk-4.0-37

      - name: Cache Tizen Studio Web CLI
        id: cache-tizen
        uses: actions/cache@v4
        with:
          path: ~/tizen-studio
          key: tizen-web-cli-${{ matrix.tizen }}-${{ runner.os }}

      - name: Install Tizen Studio Web CLI
        if: steps.cache-tizen.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          curl -fsSL -o tizen-installer.bin \
            "https://download.tizen.org/sdk/Installer/tizen-studio_${{ matrix.tizen }}/web-cli_Tizen_Studio_${{ matrix.tizen }}_ubuntu-64.bin"
          chmod +x tizen-installer.bin
          ./tizen-installer.bin --accept-license --no-java-check "$HOME/tizen-studio"

      - name: Add Tizen CLI to PATH + verify
        run: |
          set -euo pipefail
          echo "$HOME/tizen-studio/tools/ide/bin" >> "$GITHUB_PATH"
          echo "$HOME/tizen-studio/tools/command-line/bin" >> "$GITHUB_PATH"
          echo "$HOME/tizen-studio/tools" >> "$GITHUB_PATH"
          command -v tizen
          tizen version

      - name: Create CI signing profile (write profiles.xml directly)
        id: signing
        run: |
          set -euo pipefail

          PROFILE="MoonfinCI"
          echo "profile=$PROFILE" >> "$GITHUB_OUTPUT"

          # Use a simple password (Tizen has had issues with special chars in some setups). :contentReference[oaicite:1]{index=1}
          PASS="cipass1234"

          # Generate an ephemeral author cert (creates: ~/tizen-studio-data/keystore/author/author.p12)
          tizen certificate \
            -a "$PROFILE" -p "$PASS" \
            -c US -s NY -ct "New York" -o "CI" -u "CI" \
            -n "CI Build" -e "ci@example.invalid" \
            -f author

          AUTHOR="$HOME/tizen-studio-data/keystore/author/author.p12"
          test -f "$AUTHOR"

          # Tizen CLI is already loading from: ~/tizen-studio-data/profile/profiles.xml
          mkdir -p "$HOME/tizen-studio-data/profile"

          DEV_CA="$HOME/tizen-studio/tools/certificate-generator/certificates/developer/tizen-developer-ca.cer"
          DIST_CA="$HOME/tizen-studio/tools/certificate-generator/certificates/distributor/tizen-distributor-ca.cer"
          DIST_P12="$HOME/tizen-studio/tools/certificate-generator/certificates/distributor/tizen-distributor-signer.p12"
          DIST_PASS="tizenpkcs12passfordsigner"

          test -f "$DEV_CA"
          test -f "$DIST_CA"
          test -f "$DIST_P12"

          cat > "$HOME/tizen-studio-data/profile/profiles.xml" <<EOF
          <?xml version="1.0" encoding="UTF-8" standalone="no"?>
          <profiles version="3.1">
            <profile name="$PROFILE">
              <profileitem ca="$DEV_CA" distributor="0" key="$AUTHOR" password="$PASS" rootca=""/>
              <profileitem ca="$DIST_CA" distributor="1" key="$DIST_P12" password="$DIST_PASS" rootca=""/>
            </profile>
          </profiles>
          EOF

          echo "Wrote profiles.xml:"
          sed -n '1,120p' "$HOME/tizen-studio-data/profile/profiles.xml"

      - name: Install Node deps
        run: |
          set -euo pipefail
          npm install --force

      - name: Build WGT (script runs enact pack -p internally)
        env:
          TIZEN_SIGN_PROFILE: ${{ steps.signing.outputs.profile }}
        run: |
          set -euo pipefail
          node scripts/build-wgt.js --signed

      - name: Upload WGT artifact
        uses: actions/upload-artifact@v4
        with:
          name: wgt-node${{ matrix.node }}
          path: |
            build/*.wgt
            *.wgt
            dist/*.wgt
          if-no-files-found: error
